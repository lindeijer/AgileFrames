package net.agileframes.vr.space3d;

import net.agileframes.core.vr.Body;
import net.agileframes.core.forces.FuSpace;
import net.agileframes.core.traces.Scene;
import net.agileframes.core.forces.Move;
import net.agileframes.forces.xyaspace.XYASpace;

import javax.media.j3d.*;
import javax.vecmath.*;
import java.awt.*;

public class SceneAvatar3D extends Avatar3D {
  private double resolution = 0;
  private Color3f color = null;
  private Scene scene = null;

  public SceneAvatar3D(Body body) {
    super(body, -1);
    this.scene = (Scene)body;
    color = Colors.yellow;
    resolution = 3.0;// dots per meter

    addGeometry( new SceneLayout(scene, resolution, color) );
    addAppearance(Colors.yellow);
    addAppearance(Colors.green);
    addAppearance(Colors.blue);
    addAppearance(Colors.cyan);
    addAppearance(Colors.magenta);

    setGeometryAndAppearanceID(0, 0);
  }

  public void setGeometryAndAppearanceID(int geometryID, int appearanceID) {
    this.currentGeometryID = geometryID;
    this.currentAppearanceID = appearanceID;
    this.color = (Color3f)this.appearanceArray.at(this.currentAppearanceID);

    try {
      if (scene.isChanged()) {
        BaseGeometry oldGeometry = (BaseGeometry)this.geometryArray.at(this.currentGeometryID);
        BaseGeometry newGeometry = new SceneLayout(scene, resolution, color);
        this.geometryArray.replace(oldGeometry, newGeometry);
        this.currentGeometry = newGeometry;
      } else {
        this.currentGeometry = (BaseGeometry)this.geometryArray.at(this.currentGeometryID);
      }
    } catch (Exception e) { e.printStackTrace();}

    this.geometrySwitchNode.setWhichChild(this.currentGeometryID);
  }

  public void setState(FuSpace state) {
    XYASpace xyaSpace = (XYASpace)state;

    this.vectorTranslation.set(xyaSpace.getX(), xyaSpace.getY(), 0);
    this.t3dTranslation.set(this.vectorTranslation);
    this.translateTG.setTransform(this.t3dTranslation);
    this.vectorRotation.set(0, 0, xyaSpace.getAlpha());
    this.t3dRotation.setEuler(this.vectorRotation);
    this.rotateTG.setTransform(this.t3dRotation);

    try{
      if (scene.isChanged()) {
        BaseGeometry oldGeometry = (BaseGeometry)this.geometryArray.at(this.currentGeometryID);
        BaseGeometry newGeometry = new SceneLayout(scene, resolution, color);
        this.geometryArray.replace(oldGeometry, newGeometry);
        this.currentGeometry = newGeometry;
      } else {
        this.currentGeometry = (BaseGeometry)this.geometryArray.at(this.currentGeometryID);
      }
    } catch (Exception e) { e.printStackTrace();}

    this.geometrySwitchNode.setWhichChild(this.currentGeometryID);
  }
}

class SceneLayout extends BaseGeometry {
  private BranchGroup sceneBG = null;
  private Scene scene = null;
  private Color3f color = null;
  private double resolution = 0;

  public SceneLayout(Scene scene, double resolution, Color3f color) {
    this.scene = scene;
    this.resolution = resolution;
    this.color = color;

    sceneBG = new BranchGroup();
    sceneBG.setCapability(BranchGroup.ALLOW_CHILDREN_WRITE);
    sceneBG.setCapability(BranchGroup.ALLOW_CHILDREN_EXTEND);

    sceneBG.addChild(this.getLayout());
  }

  public Shape3D getLayout() {
    double totalLength = 0;
    Move[] moves = null;
    try {  moves = scene.getMoves(); } catch (Exception e) {}
    for (int i = 0; i < moves.length; i++){
      totalLength += moves[i].getManoeuvre().getTrajectory().getEvolutionEnd();
    }
    int totalSize = (int)(totalLength * resolution + 1);
    int offset = 0;
    PointArray pArray = new PointArray(totalSize, GeometryArray.COORDINATES | GeometryArray.COLOR_3);

    for (int i = 0; i < moves.length; i++) {
      double moveLength = moves[i].getManoeuvre().getTrajectory().getEvolutionEnd();
      int moveSize = (int)(moveLength * resolution + 1);
      for(int j = 0; j < moveSize; j++) {
        double u = (double)(j * moveLength / moveSize);
        FuSpace state = moves[i].getManoeuvre().getTrajectory().getTrajectPoint(u);
        XYASpace xyaSpace = (XYASpace)state;

        pArray.setCoordinate(offset + j,new Point3d(xyaSpace.getX(),xyaSpace.getY(),0));
        if (j == 0) {pArray.setColor(offset + j, Colors.red); }
        else {pArray.setColor(offset + j, color);}
      }
      offset += moveSize - 1;
    }
    return new Shape3D(pArray);
  }


  public BranchGroup getBG() {  return this.sceneBG; }
  public void setColor(Color3f color) {  this.color = color; }
  public void setText(String text) {
    Text3D text3d = new Text3D(new Font3D(new Font("Arial",Font.BOLD,3),
                                          new FontExtrusion()),
                               text,new Point3f(0,0, 3f) );
    this.sceneBG.addChild(new Shape3D(text3d));
  }
}

