package com.agileways.forces;

import java.rmi.RemoteException;

import net.agileframes.forces.MachineProxy;
import net.agileframes.forces.MachineIB;//for props
import net.agileframes.traces.ActorIB;  //for props
import net.agileframes.traces.ActorProxy;

import java.awt.*;
import java.awt.event.*;
import javax.swing.*;
import javax.swing.event.*;

public class LookUpFrame extends JFrame {
  JMenuBar menuBar1 = new JMenuBar();
  JMenu menuFile = new JMenu();
  JMenuItem menuFileExit = new JMenuItem();
  JMenu menuHelp = new JMenu();
  JMenuItem menuHelpAbout = new JMenuItem();
  JTabbedPane jTabbedPane1 = new JTabbedPane();
  FlowLayout flowLayout1 = new FlowLayout();
  JPanel machinesPanel = new JPanel();
  JPanel actorspanel = new JPanel();
  JPanel histPanel = new JPanel();
  JScrollPane jScrollPane1 = new JScrollPane();
  JPanel jPanel1 = new JPanel();
  JPanel jPanel2 = new JPanel();
  JPanel jPanel3 = new JPanel();
  JPanel jPanel4 = new JPanel();
  JPanel jPanel5 = new JPanel();
  JPanel jPanel6 = new JPanel();
  JLabel jLabel1 = new JLabel();
  JLabel jLabel2 = new JLabel();
  JList machineList = new JList();
  JLabel jLabel3 = new JLabel();
  JLabel jLabel4 = new JLabel();
  JLabel jLabel5 = new JLabel();
  JLabel jLabel6 = new JLabel();
  JLabel jLabel7 = new JLabel();
  JTextField distField = new JTextField();
  JTextField speedField = new JTextField();
  JLabel nameLabel = new JLabel();
  JTextField refSpeedField = new JTextField();
  JTextField accField = new JTextField();
  JTextField actorField = new JTextField();
  JLabel speedLabel = new JLabel();
  JTextField timeField = new JTextField();
  JTextField nameField = new JTextField();
  JCheckBox historyCheck = new JCheckBox();
  JLabel jLabel8 = new JLabel();
  JLabel jLabel9 = new JLabel();
  JLabel jLabel10 = new JLabel();
  JLabel jLabel11 = new JLabel();
  JLabel jLabel12 = new JLabel();
  JLabel jLabel13 = new JLabel();
  JLabel jLabel14 = new JLabel();
  JList actorList = new JList();
  JTextField busyField = new JTextField();
  JTextField destField = new JTextField();
  JLabel nameLabel1 = new JLabel();
  JTextField nextDestField = new JTextField();
  JTextField capField = new JTextField();
  JCheckBox historyCheck1 = new JCheckBox();
  JTextField idleField = new JTextField();
  JLabel speedLabel1 = new JLabel();
  JScrollPane jScrollPane2 = new JScrollPane();
  JTextField origField = new JTextField();
  JTextField actorNameField = new JTextField();
  JPanel jPanel7 = new JPanel();
  JPanel jPanel8 = new JPanel();
  JPanel jPanel9 = new JPanel();
  JPanel jPanel10 = new JPanel();
  JPanel jPanel11 = new JPanel();
  JPanel jPanel12 = new JPanel();
  JPanel jPanel13 = new JPanel();
  JPanel jPanel14 = new JPanel();

  //Construct the frame
  public LookUpFrame() {
    enableEvents(AWTEvent.WINDOW_EVENT_MASK);
    try  {
      jbInit();
    }
    catch(Exception e) {
      e.printStackTrace();
    }
  }

  //Component initialization
  private void jbInit() throws Exception  {
    this.getContentPane().setLayout(flowLayout1);
    this.setSize(new Dimension(410, 370));
    this.setTitle("-- AgileFrames LookUp Actors & Machines --");
    menuFile.setText("File");
    menuFileExit.setText("Exit");
    menuFileExit.addActionListener(new ActionListener()  {

      public void actionPerformed(ActionEvent e) {
        fileExit_actionPerformed(e);
      }
    });
    menuHelp.setText("Help");
    menuHelpAbout.setText("About");
    menuHelpAbout.addActionListener(new ActionListener()  {

      public void actionPerformed(ActionEvent e) {
        helpAbout_actionPerformed(e);
      }
    });
    jTabbedPane1.setPreferredSize(new Dimension(400, 315));
    jTabbedPane1.addComponentListener(new java.awt.event.ComponentAdapter() {

      public void componentShown(ComponentEvent e) {
        jTabbedPane1_componentShown(e);
      }
    });
    actorspanel.addComponentListener(new java.awt.event.ComponentAdapter() {

      public void componentShown(ComponentEvent e) {
        actorspanel_componentShown(e);
      }
    });
    machinesPanel.addComponentListener(new java.awt.event.ComponentAdapter() {

      public void componentShown(ComponentEvent e) {
        machinesPanel_componentShown(e);
      }
    });
    histPanel.addComponentListener(new java.awt.event.ComponentAdapter() {

      public void componentShown(ComponentEvent e) {
        histPanel_componentShown(e);
      }
    });
    jPanel1.setPreferredSize(new Dimension(390, 10));
    jPanel3.setPreferredSize(new Dimension(100, 250));
    jPanel2.setPreferredSize(new Dimension(270, 250));
    jPanel4.setPreferredSize(new Dimension(95, 20));
    jScrollPane1.setPreferredSize(new Dimension(95, 215));
    jPanel5.setPreferredSize(new Dimension(265, 20));
    jPanel6.setBorder(BorderFactory.createEtchedBorder());
    jPanel6.setPreferredSize(new Dimension(265, 215));
    jLabel1.setPreferredSize(new Dimension(95, 17));
    jLabel1.setText("Machines:");
    jLabel2.setPreferredSize(new Dimension(265, 17));
    jLabel2.setText("Properties:");
    jLabel3.setPreferredSize(new Dimension(150, 17));
    jLabel3.setText("Actor:");
    jLabel4.setText("Active Time:");
    jLabel4.setPreferredSize(new Dimension(150, 17));
    jLabel5.setText("Distance:");
    jLabel5.setPreferredSize(new Dimension(150, 17));
    jLabel6.setText("Ref Speed:");
    jLabel6.setPreferredSize(new Dimension(150, 17));
    jLabel7.setText("Acceleration:");
    jLabel7.setPreferredSize(new Dimension(150, 17));
    distField.setHorizontalAlignment(SwingConstants.RIGHT);
    distField.setEditable(false);
    distField.setPreferredSize(new Dimension(75, 21));
    distField.setBackground(Color.lightGray);
    distField.setBorder(null);
    speedField.setHorizontalAlignment(SwingConstants.RIGHT);
    speedField.setEditable(false);
    speedField.setPreferredSize(new Dimension(75, 21));
    speedField.setBackground(Color.lightGray);
    speedField.setBorder(null);
    nameLabel.setPreferredSize(new Dimension(150, 17));
    nameLabel.setText("Name:");
    refSpeedField.setHorizontalAlignment(SwingConstants.RIGHT);
    refSpeedField.setEditable(false);
    refSpeedField.setPreferredSize(new Dimension(75, 21));
    refSpeedField.setBackground(Color.lightGray);
    refSpeedField.setBorder(null);
    accField.setHorizontalAlignment(SwingConstants.RIGHT);
    accField.setEditable(false);
    accField.setPreferredSize(new Dimension(75, 21));
    accField.setBackground(Color.lightGray);
    accField.setBorder(null);
    actorField.setBackground(Color.lightGray);
    actorField.setBorder(null);
    actorField.setPreferredSize(new Dimension(75, 21));
    actorField.setEditable(false);
    actorField.setHorizontalAlignment(SwingConstants.RIGHT);
    speedLabel.setText("Speed:");
    speedLabel.setPreferredSize(new Dimension(150, 17));
    timeField.setHorizontalAlignment(SwingConstants.RIGHT);
    timeField.setEditable(false);
    timeField.setPreferredSize(new Dimension(75, 21));
    timeField.setBackground(Color.lightGray);
    timeField.setBorder(null);
    nameField.setBackground(Color.lightGray);
    nameField.setBorder(null);
    nameField.setPreferredSize(new Dimension(75, 21));
    nameField.setEditable(false);
    nameField.setHorizontalAlignment(SwingConstants.RIGHT);
    historyCheck.setHorizontalTextPosition(SwingConstants.LEFT);
    historyCheck.setPreferredSize(new Dimension(230, 20));
    historyCheck.setText("Keep History");
    historyCheck.addChangeListener(new javax.swing.event.ChangeListener() {

      public void stateChanged(ChangeEvent e) {
        historyCheck_stateChanged(e);
      }
    });
    jLabel8.setText("Actors:");
    jLabel8.setPreferredSize(new Dimension(95, 17));
    jLabel9.setText("Properties:");
    jLabel9.setPreferredSize(new Dimension(265, 17));
    jLabel10.setText("Idle Time:");
    jLabel10.setPreferredSize(new Dimension(150, 17));
    jLabel11.setPreferredSize(new Dimension(150, 17));
    jLabel11.setText("Origin:");
    jLabel12.setPreferredSize(new Dimension(150, 17));
    jLabel12.setText("Busy Time:");
    jLabel13.setPreferredSize(new Dimension(150, 17));
    jLabel13.setText("Next Destination:");
    jLabel14.setPreferredSize(new Dimension(150, 17));
    jLabel14.setText("Capacity:");
    busyField.setBorder(null);
    busyField.setBackground(Color.lightGray);
    busyField.setPreferredSize(new Dimension(75, 21));
    busyField.setEditable(false);
    busyField.setHorizontalAlignment(SwingConstants.RIGHT);
    destField.setBorder(null);
    destField.setBackground(Color.lightGray);
    destField.setPreferredSize(new Dimension(75, 21));
    destField.setEditable(false);
    destField.setHorizontalAlignment(SwingConstants.RIGHT);
    nameLabel1.setText("Name:");
    nameLabel1.setPreferredSize(new Dimension(150, 17));
    nextDestField.setBorder(null);
    nextDestField.setBackground(Color.lightGray);
    nextDestField.setPreferredSize(new Dimension(75, 21));
    nextDestField.setEditable(false);
    nextDestField.setHorizontalAlignment(SwingConstants.RIGHT);
    capField.setBorder(null);
    capField.setBackground(Color.lightGray);
    capField.setPreferredSize(new Dimension(75, 21));
    capField.setEditable(false);
    capField.setHorizontalAlignment(SwingConstants.RIGHT);
    historyCheck1.setText("Keep History");
    historyCheck1.setPreferredSize(new Dimension(230, 20));
    historyCheck1.setHorizontalTextPosition(SwingConstants.LEFT);
    idleField.setHorizontalAlignment(SwingConstants.RIGHT);
    idleField.setEditable(false);
    idleField.setPreferredSize(new Dimension(75, 21));
    idleField.setBorder(null);
    idleField.setBackground(Color.lightGray);
    speedLabel1.setPreferredSize(new Dimension(150, 17));
    speedLabel1.setText("Destination:");
    jScrollPane2.setPreferredSize(new Dimension(95, 215));
    origField.setHorizontalAlignment(SwingConstants.RIGHT);
    origField.setEditable(false);
    origField.setPreferredSize(new Dimension(75, 21));
    origField.setBackground(Color.lightGray);
    origField.setBorder(null);
    actorNameField.setBackground(Color.lightGray);
    actorNameField.setBorder(null);
    actorNameField.setPreferredSize(new Dimension(75, 21));
    actorNameField.setEditable(false);
    actorNameField.setHorizontalAlignment(SwingConstants.RIGHT);
    jPanel7.setPreferredSize(new Dimension(390, 10));
    jPanel8.setPreferredSize(new Dimension(270, 250));
    jPanel9.setPreferredSize(new Dimension(100, 250));
    jPanel10.setPreferredSize(new Dimension(95, 20));
    jPanel11.setPreferredSize(new Dimension(265, 20));
    jPanel12.setBorder(BorderFactory.createEtchedBorder());
    jPanel12.setPreferredSize(new Dimension(265, 215));
    jPanel13.setPreferredSize(new Dimension(390, 10));
    jPanel14.setBackground(Color.darkGray);
    jPanel14.setPreferredSize(new Dimension(390, 200));
    machineList.addMouseListener(new java.awt.event.MouseAdapter() {

      public void mouseClicked(MouseEvent e) {
        machineList_mouseClicked(e);
      }
    });
    actorList.addMouseListener(new java.awt.event.MouseAdapter() {

      public void mouseClicked(MouseEvent e) {
        actorList_mouseClicked(e);
      }
    });
    menuFile.add(menuFileExit);
    menuHelp.add(menuHelpAbout);
    menuBar1.add(menuFile);
    menuBar1.add(menuHelp);
    this.setJMenuBar(menuBar1);
    this.getContentPane().add(jTabbedPane1, null);
    jTabbedPane1.add(machinesPanel, "Machines");
    machinesPanel.add(jPanel1, null);
    machinesPanel.add(jPanel3, null);
    jPanel3.add(jPanel4, null);
    jPanel4.add(jLabel1, null);
    jPanel3.add(jScrollPane1, null);
    jScrollPane1.getViewport().add(machineList, null);
    machinesPanel.add(jPanel2, null);
    jPanel2.add(jPanel5, null);
    jPanel5.add(jLabel2, null);
    jPanel2.add(jPanel6, null);
    jPanel6.add(nameLabel, null);
    jPanel6.add(nameField, null);
    jPanel6.add(jLabel4, null);
    jPanel6.add(timeField, null);
    jPanel6.add(speedLabel, null);
    jPanel6.add(speedField, null);
    jPanel6.add(jLabel6, null);
    jPanel6.add(refSpeedField, null);
    jPanel6.add(jLabel7, null);
    jPanel6.add(accField, null);
    jPanel6.add(jLabel5, null);
    jPanel6.add(distField, null);
    jPanel6.add(jLabel3, null);
    jPanel6.add(actorField, null);
    jPanel6.add(historyCheck, null);
    jTabbedPane1.add(actorspanel, "Actors");
    actorspanel.add(jPanel7, null);
    actorspanel.add(jPanel8, null);
    jPanel8.add(jPanel11, null);
    jPanel11.add(jLabel9, null);
    jPanel8.add(jPanel12, null);
    jPanel12.add(nameLabel1, null);
    jPanel12.add(actorNameField, null);
    jPanel12.add(jLabel11, null);
    jPanel12.add(origField, null);
    jPanel12.add(speedLabel1, null);
    jPanel12.add(destField, null);
    jPanel12.add(jLabel13, null);
    jPanel12.add(nextDestField, null);
    jPanel12.add(jLabel14, null);
    jPanel12.add(capField, null);
    jPanel12.add(jLabel12, null);
    jPanel12.add(busyField, null);
    jPanel12.add(jLabel10, null);
    jPanel12.add(idleField, null);
    jPanel12.add(historyCheck1, null);
    actorspanel.add(jPanel9, null);
    jPanel9.add(jPanel10, null);
    jPanel10.add(jLabel8, null);
    jPanel9.add(jScrollPane2, null);
    jScrollPane2.getViewport().add(actorList, null);
    jTabbedPane1.add(histPanel, "History");
    histPanel.add(jPanel13, null);
    histPanel.add(jPanel14, null);

    this.setVisible(true);
    this.setEnabled(true);
    this.invalidate();
  }

  //File | Exit action performed
  public void fileExit_actionPerformed(ActionEvent e) {
    System.exit(0);
  }

  //Help | About action performed
  public void helpAbout_actionPerformed(ActionEvent e) {
    LookUpFrame_AboutBox dlg = new LookUpFrame_AboutBox(this);
    Dimension dlgSize = dlg.getPreferredSize();
    Dimension frmSize = getSize();
    Point loc = getLocation();
    dlg.setLocation((frmSize.width - dlgSize.width) / 2 + loc.x, (frmSize.height - dlgSize.height) / 2 + loc.y);
    dlg.setModal(true);
    dlg.show();
  }

  //Overridden so we can exit on System Close
  protected void processWindowEvent(WindowEvent e) {
    super.processWindowEvent(e);
    if(e.getID() == WindowEvent.WINDOW_CLOSING) {
      fileExit_actionPerformed(null);
    }
  }

  void jTabbedPane1_componentShown(ComponentEvent e) {

  }

  void actorspanel_componentShown(ComponentEvent e) {

  }

  void machinesPanel_componentShown(ComponentEvent e) {

  }

  void histPanel_componentShown(ComponentEvent e) {

  }

  void machineList_mouseClicked(MouseEvent e) {
    this.setMachineProperties();
  }

  void actorList_mouseClicked(MouseEvent e) {
    this.setActorProperties();
  }

  //////////////////////////////////////////////////////////////////////////////////////////////
  private ActorProxy[] actors;
  private String[] actorNames;
  private MachineProxy[] machines;
  private String[] machineNames;
  private final int MAXDATA = 1000;
  private final long REFRESHTIME = 800;
  private MachineIB.PropertiesIB[] machineData = new MachineIB.PropertiesIB[MAXDATA];
  private int machineDataCounter = 0;
  private int graphWidth = this.jPanel14.getWidth();
  private int graphHeight = this.jPanel14.getHeight();
  private Curve[] curves = new Curve[3];


  public void setActors(ActorProxy[] actors) {
    this.actors = actors;
    if (actors != null) {
      actorNames = new String[actors.length];
      for (int i = 0; i < actors.length; i++) {
        if (actors[i] != null) {
          actorNames[i] = actors[i].getName();
        }
      }
      actorList.setListData(actorNames);
    } else {
      actorList.setListData(new Object[] {});
    }
    setActorProperties();
  }
  public void setMachines(MachineProxy[] machines) {
    this.machines = machines;
    if (machines != null) {
      machineNames = new String[machines.length];
      for (int i = 0; i < machines.length; i++) {
        if (machines[i] != null) {
          machineNames[i] = machines[i].getName();  }
        }
      machineList.setListData(machineNames);
    } else {
      machineList.setListData(new Object[] {});
    }
    setMachineProperties();
  }
  private void collectMachineProperties() {
    if ( (machineDataCounter >= MAXDATA) || (machineList == null) || (machineList.getSelectedIndex() < 0) ) { return; }
    MachineProxy selMachine = machines[machineList.getSelectedIndex()];
    if (selMachine == null) { return; }
    MachineIB.PropertiesIB props = (MachineIB.PropertiesIB)selMachine.getProperties();
    if (machineDataCounter == 0) {
      curves[0] = new Curve(0, Color.red, 4, 0, "speed");
      curves[1] = new Curve(0, Color.yellow, 4, 0, "refSpeed");
      curves[2] = new Curve(0, Color.green, 4, -4, "refAccel");
      jPanel14.add(curves[0], null);
      jPanel14.add(curves[1], null);
      jPanel14.add(curves[2], null);
    }
    if (props != null) {
      machineData[machineDataCounter] = props;
      machineDataCounter++;
    }
  }
  private void setMachineProperties(){
    if (jTabbedPane1.getSelectedIndex() != 0) { return; }
    if ( (machineDataCounter == 0) || (machineList == null) || (machineList.getSelectedIndex() < 0) ) { emptyMachineProperties(); return; }
    MachineIB.PropertiesIB props = machineData[machineDataCounter - 1];
    nameField.setText(props.name);
    speedField.setText(doubleToString(props.speed, 2));
    distField.setText(doubleToString(props.evolution, 2));
    refSpeedField.setText(doubleToString(props.referenceSpeed, 2));
    accField.setText(doubleToString(props.acceleration, 2));
    int time = (int)props.activeTime/1000;
    int hours = time / 3600;
    int minutes = (time - hours * 3600) / 60;
    int seconds = (time - hours * 3600 - minutes * 60);
    String secStr = String.valueOf(seconds);
    if (seconds < 10) { secStr = "0"+secStr; }
    String minStr = String.valueOf(minutes);
    if (minutes < 10) { minStr = "0"+minStr; }
    timeField.setText(hours+":"+minStr+":"+secStr);
  }
  private String doubleToString(double nr, int decimals) {
    int intNr = (int) Math.abs(nr);
    int decNr = (int) Math.abs(((nr - intNr) * Math.pow(10, decimals)));
    String sign = ""; if (nr < 0) { sign = "-"; }
    return sign + intNr+"."+decNr;
  }
  private void setGraphProperties(){
    if ( (machineDataCounter == 0) || (jTabbedPane1.getSelectedIndex() != 2) ) { return; }
    MachineIB.PropertiesIB props = machineData[machineDataCounter - 1];
    curves[0].setNewValue(props.speed, props.activeTime);
    curves[1].setNewValue(props.referenceSpeed, props.activeTime);
    curves[2].setNewValue(props.acceleration, props.activeTime);
  }


  private void emptyMachineProperties() {
    nameField.setText("N/A");
    speedField.setText("N/A");
    distField.setText("N/A");
    refSpeedField.setText("N/A");
    accField.setText("N/A");
    timeField.setText("N/A");
  }
  private void emptyActorProperties() {
    busyField.setText("N/A");
    destField.setText("N/A");
    nextDestField.setText("N/A");
    capField.setText("N/A");
    idleField.setText("N/A");
    origField.setText("N/A");
    actorNameField.setText("N/A");
  }
  private void setActorProperties(){
    if (jTabbedPane1.getSelectedIndex() != 1) { return; }
    if ( (actorList == null) || (actorList.getSelectedIndex() < 0) ) { emptyActorProperties(); return; }
    ActorProxy selActor = actors[actorList.getSelectedIndex()];
    if (selActor == null) { emptyActorProperties(); return; }
    ActorIB.PropertiesIB props = null;
    try { props = (ActorIB.PropertiesIB)selActor.getProperties(); }
    catch (RemoteException e) {
      System.out.println("RemoteException while reading Actor-properties in LookUpFrame: "+e.getMessage());
      emptyActorProperties();
      actorList.remove(actorList.getSelectedIndex());
      actorList.repaint();
      return;
    }
    busyField.setText(props.busy +" %");
    destField.setText(props.destination);
    nextDestField.setText(props.nextDestination);
    //capField.setText(props.capacity);
    try {capField.setText(selActor.getMachineProxy().getName());}  catch (Exception e) {}
    idleField.setText(props.idle +" %");
    origField.setText(props.origin);
    actorNameField.setText(props.name);
  }

  private void runForRefreshData() {
    while (historyCheck.isSelected()) {
      collectMachineProperties();
      setMachineProperties();
      setGraphProperties();

      try { synchronized(this) { wait(REFRESHTIME); } }
      catch (Exception e) { e.printStackTrace(); }
    }
  }

  void historyCheck_stateChanged(ChangeEvent e) {
    if (historyCheck.isSelected()) {
      Thread dataRefreshThread = new Thread("DataRefreshThread") {
        public void run() { runForRefreshData(); }
      };
      dataRefreshThread.start();
    }
  }//------------------------------------------
  class Curve extends JComponent {
    public int beginX = 0;
    public int beginY = (int)(graphHeight*0.75);
    public long beginTime;
    private double value;
    private long time;
    private final int maxPoints = 1000;
    private Point[] points = new Point[maxPoints];
    private int counter = 0;
    private double scale, offset;
    private Color color;
    private String name;

    public Curve (long beginTime, Color color, double maxValue, double minValue, String name){
      this.beginTime = beginTime;
      this.color = color;
      this.scale = graphHeight / (maxValue - minValue);
      this.offset = minValue * scale;
      this.name = name;
      this.repaint();
    }
    public void setNewValue(double value, long time) {
      if (counter >= maxPoints) { return; }
      this.value = value;
      this.time = time - beginTime;
      int x = (int)(this.time/200);
      int y = graphHeight - (int)(this.value * scale + offset);
      points[counter] = new Point(x,y);
      if (counter > 0){
        Graphics gr = jPanel14.getGraphics();
        gr.setColor(color);
        gr.drawLine(points[counter-1].x,points[counter-1].y,points[counter].x,points[counter].y);
      }
      counter++;
    }
    public void paint(Graphics g) {
      Graphics gr = jPanel14.getGraphics();
      gr.setColor(color);
      if (points[0] != null) { gr.drawString(name, 10, points[0].y); }
      else                   { gr.drawString(name, 10, graphHeight - (int)offset); }
      for (int i=1; i < counter; i++){
        if (points[i]!=null) {
          gr.drawLine(points[i-1].x,points[i-1].y,points[i].x,points[i].y);
        }
      }
    }
    //-------------------
    class Point{
      public int x,y;
      public Point (int x, int y) { this.x = x; this.y = y; }
    }
  }
}

